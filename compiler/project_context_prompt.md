# ZH5001单片机编译器项目背景提示

## 项目概述

我正在维护一个ZH5001单片机汇编编译器项目。这是一个16位OTP型RISC单片机，具有10位指令字长、1k程序空间和48个用户RAM变量。项目的核心成果是实现了一个与原始Excel编译器100%兼容的Python编译器。

## 🔥 关键技术发现

### 1. JZ指令不对称偏移量计算（重大发现）
**背景**：通过与单片机原作者直接沟通确认了JZ指令的特殊设计
```
向前跳转: offset = target_pc - current_pc - 2
向后跳转: offset = target_pc - current_pc
```
**设计原理**：偏移量0和1在向前跳转中无实际意义，通过减2优化编码空间，在6位编码内实现65个跳转位置覆盖。

### 2. MOVC指令编码修正
- **正确编码**：`1111010100`（之前错误使用了1111010110）
- **功能**：从程序存储器查表指令

### 3. HEX文件格式标准
- 最后一行不应有换行符（与标准HEX格式一致）

## 📊 技术规格要点

### 指令集特点
- **字长**：10位定长指令
- **寻址空间**：1024程序位置，64数据位置（48用户+16系统）
- **复合指令**：LDINS（2字）、JUMP（3字预编译）、LDTAB（2字）
- **短跳转范围**：向前2-33，向后1-32

### 内存映射
```
0-47:   用户RAM变量
48-63:  特殊功能寄存器（SYSREG, IOSET0, IO, TM0_REG等）
```

## 📁 关键文件列表

### 核心组件
1. **zh5001_corrected_compiler.py** - 主编译器（最终修正版）
2. **excel_converter.py** - Excel格式转换工具
3. **zh5001_final_manual.md** - 完整编程手册（权威版本）

### 技术文档
4. **jz_instruction_final_spec.md** - JZ指令完整技术规范
5. **jz_offset_calculation_rules.md** - 偏移量计算规则总结
6. **format_standard.md** - 汇编代码格式标准

### 测试验证
7. **compiler_test_suite.py** - 编译器测试套件
8. **jz_rule_verification.py** - JZ指令规则验证脚本
9. **comprehensive_jz_test.py** - 全面JZ测试套件
10. **final_fix_verification.py** - 最终修复验证脚本

### 原始程序和示例
11. **example_1_smg.txt** - 数码管控制程序示例
12. **ZH5001单片机测试程序数码管加减一_长按.xlsm** - Excel格式原始程序
13. **ZH5001单片机测试程序跑马灯位移式.xlsm** - 跑马灯程序
14. **example_1_smg.xlsm** - 数码管程序Excel版

### 开发历程文件
15. **zh5001_compiler (1).py** - 原版编译器
16. **zh5001_enhanced_compiler (1).py** - 增强版编译器
17. **converter_test.py** - 转换器测试
18. **db_fix_verification.py** - DB指令修正验证
19. **quick_debug.py** - 快速调试工具
20. **usage_example.py** - 使用示例代码

## 🎯 项目成果

### 验证完成度
- ✅ 与原始Excel编译器输出100%匹配
- ✅ 基于原作者确认的技术规范
- ✅ 完整指令集支持（40+指令）
- ✅ 多格式输出（HEX/JSON/Verilog）
- ✅ 系统性测试验证覆盖

### 实际应用案例
分析了两个完整的实际程序：
1. **数码管加减控制**：339条指令，13个JZ，复杂状态机
2. **跑马灯位移控制**：24条指令，2个JZ，简单循环逻辑

## 🔍 分析发现的问题和解决

### 问题1：JZ偏移量计算错误
**初始假设**：`offset = target_pc - current_pc - 1`（基于传统CPU模型）
**实际发现**：不对称计算规则，向前跳转需要额外减2
**解决过程**：通过实际Excel编译结果逆向分析 + 原作者确认

### 问题2：指令编码不准确
**MOVC指令**：从错误的1111010110修正为1111010100
**验证方法**：与实际硬件行为对比

### 问题3：输出格式细节
**HEX文件**：标准化格式要求最后一行无换行符
**Verilog输出**：正确的c_m[pc]格式生成

## 🛠️ 技术栈和依赖

### 核心技术
- **Python 3.6+** - 主要开发语言
- **openpyxl** - Excel文件处理（可选）
- **标准库** - 无外部依赖的核心功能

### 架构设计
- **模块化编译器**：词法分析 → 预编译 → 代码生成 → 多格式输出
- **数据结构**：Instruction, PrecompiledInstruction, MachineCode等dataclass
- **错误处理**：详细的语法和语义检查，警告系统

## 📋 使用场景

### 主要用途
1. **汇编程序编译**：.asm文件 → .hex机器码
2. **Excel程序转换**：.xlsm ↔ .asm格式互转
3. **代码验证调试**：语法检查、跳转范围验证
4. **硬件仿真支持**：生成Verilog初始化代码

### 典型工作流
```bash
# Excel转标准汇编
python excel_converter.py program.xlsm -m excel-to-text -o program.asm

# 编译生成机器码
python zh5001_corrected_compiler.py program.asm -v --validate

# 验证编译器功能
python compiler_test_suite.py
```

## ⚠️ 重要注意事项

### 设计约束
1. **JZ跳转限制**：向前最小距离2，最大距离33；向后最大距离32
2. **变量地址范围**：0-63，其中48-63为系统保留
3. **程序空间限制**：最大1024条指令
4. **指令预编译**：LDINS/JUMP/LDTAB会展开为多条指令

### 调试要点
1. **偏移量计算**：确保理解不对称规则
2. **Excel格式解析**：注意列对应关系（B列标号，C列指令，D列操作数）
3. **标号处理**：标号不占PC，指向下一条实际指令
4. **数据类型**：DB指令生成10位数据，范围0-1023

## 💡 下次迭代建议

### 可能的扩展方向
1. **IDE集成**：语法高亮、自动补全、实时编译
2. **调试器**：单步调试、断点设置、变量监视
3. **优化器**：代码优化、跳转距离优化、死代码消除
4. **仿真器**：完整的ZH5001指令集仿真环境

### 技术债务
1. **测试覆盖**：增加更多边界情况测试
2. **错误信息**：提供更详细的修复建议
3. **性能优化**：大程序编译速度优化
4. **文档完善**：更多实际应用示例

---

**使用此提示时**：直接引用相关文件名和技术细节，所有规则和实现都已经过实际验证。项目处于稳定可用状态，核心功能完整。