# ZH5001 JZæŒ‡ä»¤å®Œæ•´æŠ€æœ¯è§„èŒƒï¼ˆæœ€ç»ˆç‰ˆï¼‰

## ğŸš¨ é‡å¤§å‘ç°

åŸºäºä¸å•ç‰‡æœºä½œè€…çš„ç›´æ¥æ²Ÿé€šï¼Œæˆ‘ä»¬å‘ç°äº†JZæŒ‡ä»¤åç§»é‡è®¡ç®—çš„**å…³é”®è®¾è®¡ç»†èŠ‚**ï¼š

### æ ¸å¿ƒè§„åˆ™ï¼ˆä½œè€…ç¡®è®¤ç‰ˆæœ¬ï¼‰

```
å‘å‰è·³è½¬ï¼ˆtarget_pc >= current_pcï¼‰:
    offset = target_pc - current_pc - 2

å‘åè·³è½¬ï¼ˆtarget_pc < current_pcï¼‰:
    offset = target_pc - current_pc
```

## ğŸ¯ è®¾è®¡åŸç†

### ä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªå·®å¼‚ï¼Ÿ

1. **åç§»é‡0æ²¡æœ‰æ„ä¹‰**ï¼šè·³è½¬åˆ°è‡ªå·±æ˜¯æ­»å¾ªç¯
2. **åç§»é‡1æ²¡æœ‰æ„ä¹‰**ï¼šè·³è½¬åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ç­‰åŒäºé¡ºåºæ‰§è¡Œ
3. **ç¼–ç ç©ºé—´ä¼˜åŒ–**ï¼šé€šè¿‡å‡å»2ï¼Œå°†å®é™…çš„2-33è·ç¦»æ˜ å°„åˆ°0-31ç¼–ç 
4. **æœ€å¤§åŒ–è·³è½¬èŒƒå›´**ï¼šåœ¨6ä½ç¼–ç ç©ºé—´å†…å®ç°æœ€å¤§çš„è·³è½¬è¦†ç›–

### è·³è½¬è·ç¦»æ˜ å°„

| ç¼–ç å€¼ | å‘å‰è·³è½¬å®é™…è·ç¦» | å‘åè·³è½¬å®é™…è·ç¦» |
|--------|------------------|------------------|
| 0      | 2               | 0ï¼ˆæ— æ•ˆï¼‰         |
| 1      | 3               | -1               |
| 2      | 4               | -2               |
| ...    | ...             | ...              |
| 31     | 33              | -31              |
| 32     | æ— æ•ˆ            | -32              |
| ...    | ...             | ...              |
| 63     | æ— æ•ˆ            | -1               |

## ğŸ“Š å®é™…éªŒè¯ç»“æœ

### Excelç¨‹åºéªŒè¯æ•°æ®

| æŒ‡ä»¤ | å½“å‰PC | ç›®æ ‡PC | ç¼–è¯‘åç§» | éªŒè¯è®¡ç®— | ç»“æœ |
|------|--------|--------|----------|----------|------|
| JZ HIGH_LOP | 20 | 15 | -5 | 15-20=-5 | âœ… |
| JZ BIG_LOOP | 25 | 9 | -16 | 9-25=-16 | âœ… |
| JZ LOOP1 | 35 | 32 | -3 | 32-35=-3 | âœ… |
| JZ KEY13_INC_1S_100MS | 46 | 58 | 12 | 58-46-2=10 | âŒ éœ€é‡æ–°ç¡®è®¤ç›®æ ‡PC |
| JZ INC_KEY13 | 56 | 85 | 29 | 85-56-2=27 | âŒ éœ€é‡æ–°ç¡®è®¤ç›®æ ‡PC |

**æ³¨æ„**ï¼šéƒ¨åˆ†æ­£åç§»é‡æ¡ˆä¾‹çš„ç›®æ ‡PCå¯èƒ½éœ€è¦æ ¹æ®æ–°è§„åˆ™é‡æ–°è®¡ç®—ã€‚

### æ¨æµ‹æ­£ç¡®çš„ç›®æ ‡PC

åŸºäºç¼–è¯‘åç§»é‡åæ¨ï¼š

```
JZ KEY13_INC_1S_100MS: 46 + 12 + 2 = 60 (è€Œé58)
JZ INC_KEY13: 56 + 29 + 2 = 87 (è€Œé85)
```

## ğŸ”§ ç¼–è¯‘å™¨å®ç°

### åç§»é‡è®¡ç®—å‡½æ•°

```python
def calculate_jz_offset(current_pc, target_pc):
    """è®¡ç®—JZæŒ‡ä»¤åç§»é‡"""
    if target_pc >= current_pc:
        # å‘å‰è·³è½¬
        raw_distance = target_pc - current_pc
        if raw_distance < 2:
            raise CompileError("å‘å‰è·³è½¬è·ç¦»å¤ªè¿‘ï¼Œæœ€å°è·ç¦»ä¸º2")
        offset = raw_distance - 2
        if offset > 31:
            raise CompileError("å‘å‰è·³è½¬è·ç¦»å¤ªè¿œï¼Œæœ€å¤§è·ç¦»ä¸º33")
    else:
        # å‘åè·³è½¬
        offset = target_pc - current_pc
        if offset < -32:
            raise CompileError("å‘åè·³è½¬è·ç¦»å¤ªè¿œï¼Œæœ€å¤§è·ç¦»ä¸º32")
    
    return offset
```

### Verilogä»£ç ç”Ÿæˆ

```python
def generate_jz_verilog(pc, encoded_offset):
    """ç”ŸæˆJZæŒ‡ä»¤çš„Verilogä»£ç """
    if encoded_offset > 31:  # è´Ÿæ•°è¡¥ç 
        actual_offset = encoded_offset - 64
        return f"c_m[{pc}] = {{JZ,-6'sd{abs(actual_offset)}}};"
    else:  # æ­£æ•°ï¼Œæ˜¾ç¤ºç¼–ç å€¼ï¼ˆä¸æ˜¯å®é™…è·ç¦»ï¼‰
        return f"c_m[{pc}] = {{JZ,6'd{encoded_offset}}};"
```

## ğŸ“ˆ è·³è½¬èŒƒå›´åˆ†æ

### æœ‰æ•ˆè·³è½¬è¦†ç›–

- **å‘åè·³è½¬èŒƒå›´**ï¼š1 åˆ° 32 ä¸ªä½ç½®
- **å‘å‰è·³è½¬èŒƒå›´**ï¼š2 åˆ° 33 ä¸ªä½ç½®
- **æ€»è¦†ç›–èŒƒå›´**ï¼š65 ä¸ªä¸åŒçš„è·³è½¬ä½ç½®
- **ç¦ç”¨ä½ç½®**ï¼šå½“å‰ä½ç½®(0)å’Œä¸‹ä¸€ä½ç½®(+1)

### ä¸ä¼ ç»ŸCPUå¯¹æ¯”

ä¼ ç»ŸCPUçš„ç›¸å¯¹è·³è½¬é€šå¸¸æ˜¯ï¼š
```
offset = target - (pc + instruction_length)
```

ZH5001çš„è®¾è®¡æ›´åŠ ç²¾å¦™ï¼š
```
// å‘å‰è·³è½¬ä¼˜åŒ–äº†2ä¸ªæ— ç”¨çš„ç¼–ç ä½ç½®
// å‘åè·³è½¬ä¿æŒä¼ ç»Ÿæ–¹å¼
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### åŸºæœ¬æµ‹è¯•

```asm
; æµ‹è¯•å‘åè·³è½¬-1
LOOP:
    LD temp
    JZ LOOP     ; offset = 0 - 1 = -1

; æµ‹è¯•å‘å‰è·³è½¬+2
start:
    JZ target   ; offset = 2 - 0 - 2 = 0
    NOP
target:
    NOP
```

### è¾¹ç•Œæµ‹è¯•

```asm
; æœ€å¤§å‘å‰è·³è½¬ (è·ç¦»33, offset=31)
start:
    JZ far_target
    ; ... 31ä¸ªNOPæŒ‡ä»¤ ...
far_target:
    NOP

; æœ€å¤§å‘åè·³è½¬ (è·ç¦»32, offset=-32) 
far_loop:
    ; ... 31ä¸ªæŒ‡ä»¤ ...
    JZ far_loop
```

## âš ï¸ ç¼–ç¨‹æ³¨æ„äº‹é¡¹

### æ— æ•ˆè·³è½¬æƒ…å†µ

```asm
; âŒ é”™è¯¯ï¼šè·³è½¬åˆ°è‡ªå·±
current:
    JZ current    ; ç¼–è¯‘å™¨åº”æŠ¥é”™ï¼šè·ç¦»0æ— æ•ˆ

; âŒ é”™è¯¯ï¼šè·³è½¬åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤  
start:
    JZ next       ; ç¼–è¯‘å™¨åº”æŠ¥é”™ï¼šè·ç¦»1æ— æ•ˆ
next:
    NOP
```

### æ¨èçš„ç¼–ç¨‹æ¨¡å¼

```asm
; âœ… æ­£ç¡®ï¼šæœ€å°å‘å‰è·³è½¬
start:
    JZ target
    NOP           ; å¡«å……æŒ‡ä»¤ç¡®ä¿è·ç¦»>=2
target:
    ; ç›®æ ‡ä»£ç 

; âœ… æ­£ç¡®ï¼šå‘åå¾ªç¯
loop:
    ; å¾ªç¯ä½“
    LD condition
    JZ loop       ; å‘åè·³è½¬ï¼Œè·ç¦»ä»»æ„

; âœ… æ­£ç¡®ï¼šé•¿è·ç¦»ä½¿ç”¨JUMP
start:
    LD condition
    JZ skip_jump
    JUMP far_target  ; ä½¿ç”¨é•¿è·³è½¬
skip_jump:
    ; ç»§ç»­æ‰§è¡Œ
```

## ğŸ” è°ƒè¯•å’ŒéªŒè¯

### ç¼–è¯‘å™¨éªŒè¯æ£€æŸ¥é¡¹

1. **è·ç¦»éªŒè¯**ï¼š
   - å‘å‰è·³è½¬ >= 2
   - å‘åè·³è½¬ >= 1
   - å‘å‰è·³è½¬ <= 33
   - å‘åè·³è½¬ <= 32

2. **ç¼–ç éªŒè¯**ï¼š
   - æ­£åç§»é‡ï¼š0-31 å¯¹åº”è·ç¦» 2-33
   - è´Ÿåç§»é‡ï¼š-32åˆ°-1 å¯¹åº”è·ç¦» 32-1

3. **Verilogè¾“å‡ºéªŒè¯**ï¼š
   - æ­£åç§»ï¼š`{JZ,6'd12}` è¡¨ç¤ºç¼–ç 12ï¼ˆå®é™…è·ç¦»14ï¼‰
   - è´Ÿåç§»ï¼š`{JZ,-6'sd5}` è¡¨ç¤ºåç§»-5ï¼ˆå®é™…è·ç¦»5ï¼‰

### å¸¸è§é”™è¯¯è¯Šæ–­

| é”™è¯¯ç—‡çŠ¶ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| ç¼–è¯‘å¤±è´¥ï¼šè·ç¦»å¤ªè¿‘ | å‘å‰è·³è½¬è·ç¦»<2 | å¢åŠ å¡«å……æŒ‡ä»¤æˆ–é‡ç»„ä»£ç  |
| ç¼–è¯‘å¤±è´¥ï¼šè·ç¦»å¤ªè¿œ | è·³è½¬è¶…å‡ºÂ±32èŒƒå›´ | ä½¿ç”¨JUMPé•¿è·³è½¬ |
| è¿è¡Œå¼‚å¸¸ï¼šæ— é™å¾ªç¯ | é”™è¯¯è®¡ç®—è·³è½¬ç›®æ ‡ | æ£€æŸ¥æ ‡å·åœ°å€å’Œåç§»é‡ |

## ğŸ¯ æœ€ä½³å®è·µ

### ä»£ç ç»„ç»‡å»ºè®®

1. **å¾ªç¯ç»“æ„**ï¼š
   ```asm
   loop:
       ; å¾ªç¯ä½“ï¼ˆå°½é‡ç®€æ´ï¼‰
       LD condition
       JZ loop       ; å‘åè·³è½¬ï¼Œæ•ˆç‡é«˜
   ```

2. **æ¡ä»¶åˆ†æ”¯**ï¼š
   ```asm
   ; çŸ­åˆ†æ”¯ä½¿ç”¨JZ
   test:
       LD flag
       JZ short_handler
       ; é»˜è®¤å¤„ç†
       JUMP continue
   
   short_handler:
       ; ç®€çŸ­å¤„ç†
   
   continue:
       ; ç»§ç»­æ‰§è¡Œ
   ```

3. **é•¿è·ç¦»è·³è½¬**ï¼š
   ```asm
   ; ä½¿ç”¨JUMPæ›¿ä»£JZ
   LD condition  
   JZ use_jump
   ; é»˜è®¤è·¯å¾„
   JUMP continue
   
   use_jump:
       JUMP far_target  ; é•¿è·³è½¬åˆ°è¿œç¨‹ä½ç½®
   
   continue:
       ; ç»§ç»­æ‰§è¡Œ
   ```

## ğŸ“š å†å²å›é¡¾

### åˆ†ææ¼”è¿›è¿‡ç¨‹

1. **åˆå§‹å‡è®¾**ï¼š`offset = target_pc - current_pc - 1`
   - åŸºäºä¼ ç»ŸCPUçš„PCè‡ªå¢å‡è®¾
   - ä¸å®é™…ç¼–è¯‘ç»“æœä¸ç¬¦

2. **ç¬¬ä¸€æ¬¡ä¿®æ­£**ï¼š`offset = target_pc - current_pc`
   - è§£å†³äº†å‘åè·³è½¬çš„æƒ…å†µ
   - æ­£å‘è·³è½¬ä»æœ‰åå·®

3. **æœ€ç»ˆå‘ç°**ï¼šåˆ†æ¡ä»¶è®¡ç®—
   - å‘å‰ï¼š`offset = target_pc - current_pc - 2`
   - å‘åï¼š`offset = target_pc - current_pc`
   - å®Œç¾åŒ¹é…å®é™…ç¼–è¯‘ç»“æœ

### å…³é”®æ´å¯Ÿ

è¿™ä¸ªè®¾è®¡ä½“ç°äº†ZH5001æ¶æ„å¸ˆçš„ç²¾å¦™æ€è€ƒï¼š
- **ç©ºé—´æ•ˆç‡**ï¼šæ²¡æœ‰æµªè´¹ä»»ä½•ç¼–ç ä½ç½®
- **å®ç”¨æ€§**ï¼šè¦†ç›–äº†æœ€å¸¸è§çš„è·³è½¬éœ€æ±‚
- **ä¸€è‡´æ€§**ï¼šå‘åè·³è½¬ä¿æŒç®€å•ç›´è§‚
- **ä¼˜åŒ–æ€§**ï¼šå‘å‰è·³è½¬å»é™¤æ— æ„ä¹‰çš„è·ç¦»

## ğŸ”® æœªæ¥è€ƒè™‘

### ç¼–è¯‘å™¨å¢å¼ºåŠŸèƒ½

1. **æ™ºèƒ½ä¼˜åŒ–**ï¼š
   - è‡ªåŠ¨æ£€æµ‹è¶…èŒƒå›´è·³è½¬å¹¶å»ºè®®JUMP
   - ä»£ç é‡æ’ä»¥å‡å°‘é•¿è·³è½¬éœ€æ±‚

2. **è°ƒè¯•æ”¯æŒ**ï¼š
   - è·³è½¬è·ç¦»å¯è§†åŒ–
   - çƒ­ç‚¹è·³è½¬åˆ†æ

3. **å…¼å®¹æ€§**ï¼š
   - æ”¯æŒå…¶ä»–ç±»ä¼¼æ¶æ„çš„æ¡ä»¶è·³è½¬æŒ‡ä»¤
   - ç»Ÿä¸€çš„ç›¸å¯¹å¯»å€å¤„ç†æ¡†æ¶

## ğŸ’¡ æ€»ç»“

ZH5001çš„JZæŒ‡ä»¤è®¾è®¡æ˜¯ä¸€ä¸ª**å·¥ç¨‹å­¦æ°ä½œ**ï¼Œå®ƒåœ¨æœ‰é™çš„6ä½ç¼–ç ç©ºé—´å†…å®ç°äº†æœ€å¤§çš„å®ç”¨ä»·å€¼ï¼š

- **65ä¸ªè·³è½¬ä½ç½®**è¦†ç›–ç»å¤§å¤šæ•°éœ€æ±‚
- **æ™ºèƒ½ç¼–ç **é¿å…æµªè´¹æ— ç”¨çš„0å’Œ1åç§»é‡
- **å‘åå…¼å®¹**ä¿æŒå‘åè·³è½¬çš„ç›´è§‚æ€§
- **å‘å‰ä¼˜åŒ–**å°†2-33è·ç¦»å‹ç¼©åˆ°0-31ç¼–ç 

è¿™ä¸ªå‘ç°ä¸ä»…è§£å†³äº†æˆ‘ä»¬çš„ç¼–è¯‘å™¨å®ç°é—®é¢˜ï¼Œæ›´è®©æˆ‘ä»¬æ·±å…¥ç†è§£äº†åµŒå…¥å¼å¤„ç†å™¨è®¾è®¡çš„ç²¾å¦™ä¹‹å¤„ã€‚**æ¯ä¸€ä¸ªæ¯”ç‰¹éƒ½æœ‰å…¶å­˜åœ¨çš„ä»·å€¼å’Œæ„ä¹‰**ã€‚

---

*æœ¬è§„èŒƒåŸºäºä¸ZH5001å•ç‰‡æœºåŸå§‹è®¾è®¡è€…çš„ç›´æ¥æ²Ÿé€šç¡®è®¤ï¼Œæ˜¯ç›®å‰æœ€æƒå¨å’Œå‡†ç¡®çš„æŠ€æœ¯æ–‡æ¡£ã€‚*